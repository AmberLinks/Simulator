<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>給与＆シフト・シミュレーター（SPA）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
    body {
        font-family: 'Inter', 'Noto Sans JP', sans-serif;
        background-color: #f1f5f9; /* slate-100 */
    }
    .card { @apply bg-white rounded-xl shadow-sm p-6; }
    .mono { font-variant-numeric: tabular-nums; }
    .result-box { @apply bg-slate-50 rounded-lg p-4 text-center; }
    .btn { @apply w-full px-4 py-2 rounded-lg text-sm font-semibold text-white transition-colors shadow-sm; }
    .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700; }
    .btn-secondary { @apply bg-slate-700 hover:bg-slate-800; }
  </style>
</head>
<body class="text-slate-800">
  <main class="max-w-5xl mx-auto px-4 py-8 sm:py-12">
    <header class="text-center mb-8">
      <h1 class="text-3xl lg:text-4xl font-bold text-slate-900">給与＆シフト・シミュレーター</h1>
      <p class="text-slate-600 mt-2">勤務体系を自由に組み合わせて、給与の変化をリアルタイムで確認できます。</p>
    </header>

    <!-- Controls -->
    <section class="card mb-8">
      <h2 class="text-xl font-semibold mb-5 border-b pb-3">計算パラメータ</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        <label class="block">
          <span class="text-sm font-medium text-slate-600">基本時給（円）</span>
          <input id="hourly" type="number" inputmode="numeric" class="mt-1 w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                 value="1500" min="0" step="50">
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-600">18:00以降の時給（円）</span>
          <input id="eveningHourly" type="number" inputmode="numeric" class="mt-1 w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                 value="2000" min="0" step="50">
        </label>
        <div class="block">
          <span class="text-sm font-medium text-slate-600 flex items-center">
            月の週数換算 (参考値)
            <span class="ml-1.5 text-slate-400 cursor-help" title="1年の週数(約52.14週) ÷ 12ヶ月 ≈ 4.345週。計算には慣例値の4.33を使用しています。">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.061-1.061 3 3 0 112.871 5.026v.345a.75.75 0 01-1.5 0v-.5c0-.72.57-1.172 1.081-1.287A1.5 1.5 0 108.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
              </svg>
            </span>
          </span>
          <p class="mt-2 text-lg font-semibold text-slate-800 mono">4.33</p>
        </div>
      </div>
    </section>

    <!-- Schedule Selector -->
    <section class="card mb-8">
        <h2 class="text-xl font-semibold mb-5 border-b pb-3">週間シフト設定</h2>
        <div class="mb-6">
            <h3 class="text-sm font-medium text-slate-600 mb-3">サンプルシフトを読込（水曜・日曜休みベース）</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <button id="presetA" class="text-left p-4 rounded-lg border bg-slate-50 hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <h4 class="font-semibold text-slate-800">基本パターン</h4>
                    <p class="text-sm text-slate-500 mt-1">週5日・40時間勤務の基本形です。</p>
                </button>
                <button id="presetB" class="text-left p-4 rounded-lg border bg-slate-50 hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <h4 class="font-semibold text-slate-800">休日出勤パターン</h4>
                    <p class="text-sm text-slate-500 mt-1">基本勤務に加え、水曜に4時間出勤します。</p>
                </button>
                <button id="presetC" class="text-left p-4 rounded-lg border bg-slate-50 hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <h4 class="font-semibold text-slate-800">長時間MIXパターン</h4>
                    <p class="text-sm text-slate-500 mt-1">週1日を長時間、週4日を通常勤務にします。</p>
                </button>
                 <button id="presetD" class="text-left p-4 rounded-lg border bg-slate-50 hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <h4 class="font-semibold text-slate-800">シフト調整パターン</h4>
                    <p class="text-sm text-slate-500 mt-1">遅番の翌日は時短勤務になるパターンです。</p>
                </button>
            </div>
        </div>
        <div id="schedule-selectors" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4 border-t pt-5">
            <!-- Day selectors will be injected here by JS -->
        </div>
    </section>

    <!-- Results -->
    <section class="card" id="resultsPanel">
        <h2 class="text-xl font-semibold mb-5 border-b pb-3">シミュレーション結果</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="result-box">
                <div class="text-sm text-slate-500">週あたり労働時間</div>
                <div id="res-weekHours" class="text-2xl font-bold mono text-indigo-600">0.00 h</div>
            </div>
            <div class="result-box">
                <div class="text-sm text-slate-500">週給（概算）</div>
                <div id="res-weeklyPay" class="text-2xl font-bold mono text-indigo-600">¥0</div>
            </div>
            <div class="result-box">
                <div class="text-sm text-slate-500">月給（概算）</div>
                <div id="res-monthlyPay" class="text-2xl font-bold mono text-indigo-600">¥0</div>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 text-center">
            <div class="bg-slate-50 rounded-lg p-2">
                <div class="text-xs text-slate-500">通常時間</div>
                <div id="res-regularHours" class="font-semibold mono">0.00 h</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-2">
                <div class="text-xs text-slate-500">夜間時間 (18時以降)</div>
                <div id="res-eveningHours" class="font-semibold mono">0.00 h</div>
            </div>
             <div class="bg-slate-50 rounded-lg p-2">
                <div class="text-xs text-slate-500">法定時間外</div>
                <div id="res-overtimeHours" class="font-semibold mono text-red-600">0.00 h</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-2">
                <div class="text-xs text-slate-500">残業代 (概算)</div>
                <div id="res-overtimePay" class="font-semibold mono text-red-600">¥0</div>
            </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500 border-b-2">
                <th class="py-2 pr-3">曜日</th>
                <th class="py-2 pr-3">シフト</th>
                <th class="py-2 pr-3 text-right">実働（h）</th>
              </tr>
            </thead>
            <tbody id="schedule-details">
                <!-- Schedule details will be injected here -->
            </tbody>
            <tfoot class="font-semibold">
                <tr>
                    <td colspan="2" class="py-2 pr-3 text-right text-slate-600">週合計</td>
                    <td id="total-hours-footer" class="py-2 pr-3 text-right mono">0.00 h</td>
                </tr>
            </tfoot>
          </table>
        </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">
      <hr class="mb-4">
      <p>※ 法定時間外労働（1日8時間・週40時間を超える分）は基本時給の1.25倍で計算されます。<br>
      ※ 休日出勤の割増率は異なる場合があります。税金・社会保険料は考慮していません。あくまで目安としてご活用ください。</p>
    </footer>
  </main>

  <script>
    const DAYS = ["月", "火", "水", "木", "金", "土", "日"];
    const yen = (n) => "¥" + Math.round(n).toLocaleString("ja-JP");
    const hoursFmt = (h) => (Math.round(h * 100) / 100).toFixed(2) + " h";
    
    const SHIFTS = {
      'off': { name: "休日", shifts: [] },
      's1': { name: "出勤① 8:00-17:00", shifts: [{ start:"08:00", end:"17:00", breakMin:60 }] },
      's2': { name: "出勤② 12:30-17:00", shifts: [{ start:"12:30", end:"17:00", breakMin:0 }] },
      's3': { name: "出勤③ 8:00-22:00", shifts: [{ start:"08:00", end:"22:00", breakMin:90 }] }, // 14h拘束のため休憩1.5hと想定 -> 12.5h
      's4': { name: "出勤④ 18:00-22:00", shifts: [{ start:"18:00", end:"22:00", breakMin:0 }] },
      's5': { name: "出勤⑤ 12:30-22:00", shifts: [{ start:"12:30", end:"22:00", breakMin:90 }] }, // 9.5h拘束のため休憩1.5hと想定 -> 8h
    };
    
    // Sample Patterns (Wednesday & Sunday off base)
    const PATTERN_A = ['s1',  's1',  'off', 's1',  's1',  's1',  'off']; // 基本: 5 days, 40h
    const PATTERN_B = ['s1',  's1',  's4',  's1',  's1',  's1',  'off']; // 週5日勤務 + 水曜4h: 6 days, 44h
    // 月曜の長時間勤務(s3)を、ルールに沿って火曜に移動
    const PATTERN_C = ['s1',  's3',  'off', 's1',  's1',  's1',  'off']; // 週1長時間 + 週4通常: 5 days, 44.5h
    const PATTERN_D = ['s1',  's5',  's2',  's1',  's1',  'off', 'off']; // 遅番→時短: 5 days, 36.5h

    const state = {
      hourly: 1500,
      eveningHourly: 2000,
      weeksPerMonth: 4.33,
      schedule: [...PATTERN_A], // Default schedule
    };

    function parseHHMM(s) {
      const [H, M] = s.split(":").map(Number);
      return H * 60 + M;
    }

    function calculateMinutes(shifts) {
        const eveningStart = parseHHMM("18:00");
        let totalMin = 0, regularMin = 0, eveningMin = 0;

        shifts.forEach(sh => {
            const start = parseHHMM(sh.start);
            const end = parseHHMM(sh.end);
            const span = end - start;
            if (span <= 0) return;

            const netWorkMin = span - (sh.breakMin || 0);
            
            const eveningSpan = Math.max(0, end - eveningStart);
            const regularSpan = span - eveningSpan;
            
            // 休憩時間を労働時間に比例して按分
            const eveningPortion = (span > 0) ? eveningSpan / span : 0;
            const breakInEvening = (sh.breakMin || 0) * eveningPortion;
            
            const netEveningMin = Math.max(0, eveningSpan - breakInEvening);
            const netRegularMin = netWorkMin - netEveningMin;
            
            totalMin += netWorkMin;
            regularMin += netRegularMin;
            eveningMin += netEveningMin;
        });
        return { totalMin, regularMin, eveningMin };
    }

    function calculateMetrics() {
        const dailyMetrics = state.schedule.map(key => calculateMinutes(SHIFTS[key].shifts));
        const dailyTotalMinutes = dailyMetrics.map(m => m.totalMin);

        let totalOvertimeMin = 0;
        let weeklyCumulativeMin = 0;
        const weeklyLimit = 40 * 60;
        
        dailyTotalMinutes.forEach(dailyMin => {
            const dailyLimit = 8 * 60;
            const dailyOvertime = Math.max(0, dailyMin - dailyLimit);
            
            const projectedTotal = weeklyCumulativeMin + dailyMin;
            const weeklyOvertimeSoFar = Math.max(0, weeklyCumulativeMin - weeklyLimit);
            const weeklyOvertimeNow = Math.max(0, projectedTotal - weeklyLimit);
            const weeklyOvertimeForDay = weeklyOvertimeNow - weeklyOvertimeSoFar;

            totalOvertimeMin += Math.max(dailyOvertime, weeklyOvertimeForDay);
            weeklyCumulativeMin += dailyMin;
        });
        
        const totalRegularMin = dailyMetrics.reduce((sum, m) => sum + m.regularMin, 0);
        const totalEveningMin = dailyMetrics.reduce((sum, m) => sum + m.eveningMin, 0);
        const totalWorkMin = totalRegularMin + totalEveningMin;

        const overtimeRegularMin = Math.min(totalOvertimeMin, totalRegularMin);
        const overtimeEveningMin = totalOvertimeMin - overtimeRegularMin;

        const baseRegularMin = totalRegularMin - overtimeRegularMin;
        const baseEveningMin = totalEveningMin - overtimeEveningMin;

        const regularPay = (baseRegularMin / 60) * state.hourly;
        const eveningPay = (baseEveningMin / 60) * state.eveningHourly;
        const overtimePayVal = (totalOvertimeMin / 60) * state.hourly * 1.25;

        const weeklyPay = regularPay + eveningPay + overtimePayVal;
        const monthlyPay = weeklyPay * state.weeksPerMonth;

        return {
            weekHours: totalWorkMin / 60,
            regularHours: totalRegularMin / 60,
            eveningHours: totalEveningMin / 60,
            overtimeHours: totalOvertimeMin / 60,
            weeklyPay,
            monthlyPay,
            overtimePay: overtimePayVal,
            dailyMinutes: dailyTotalMinutes,
        };
    }

    function render() {
      // Update state from inputs
      state.hourly = Number(document.getElementById("hourly").value) || 0;
      state.eveningHourly = Number(document.getElementById("eveningHourly").value) || 0;
      // weeksPerMonth is now fixed in the state object
      state.schedule = DAYS.map((_, i) => document.getElementById(`day-${i}`).value);

      const metrics = calculateMetrics();

      // Render results
      document.getElementById("res-weekHours").textContent = hoursFmt(metrics.weekHours);
      document.getElementById("res-weeklyPay").textContent = yen(metrics.weeklyPay);
      document.getElementById("res-monthlyPay").textContent = yen(metrics.monthlyPay);
      document.getElementById("res-regularHours").textContent = hoursFmt(metrics.regularHours);
      document.getElementById("res-eveningHours").textContent = hoursFmt(metrics.eveningHours);
      document.getElementById("res-overtimeHours").textContent = hoursFmt(metrics.overtimeHours);
      document.getElementById("res-overtimePay").textContent = yen(metrics.overtimePay);
      
      // Render schedule details table
      const scheduleDetails = document.getElementById("schedule-details");
      scheduleDetails.innerHTML = "";
      DAYS.forEach((day, i) => {
        const shiftKey = state.schedule[i];
        const shiftInfo = SHIFTS[shiftKey];
        const dailyStr = shiftInfo.name;
        
        const tr = document.createElement('tr');
        tr.className = "border-b last:border-0";
        tr.innerHTML = `
          <td class="py-2.5 pr-3 font-medium">${day}</td>
          <td class="py-2.5 pr-3 ${shiftKey === 'off' ? 'text-slate-400' : ''}">${dailyStr}</td>
          <td class="py-2.5 pr-3 text-right mono">${hoursFmt(metrics.dailyMinutes[i]/60)}</td>
        `;
        scheduleDetails.appendChild(tr);
      });
      document.getElementById("total-hours-footer").textContent = hoursFmt(metrics.weekHours);
    }
    
    function loadPattern(pattern) {
        pattern.forEach((shiftKey, i) => {
            const selector = document.getElementById(`day-${i}`);
            if (selector.querySelector(`option[value="${shiftKey}"]`)) {
                 selector.value = shiftKey;
            }
        });
        render();
    }

    function setup() {
        const scheduleSelectors = document.getElementById('schedule-selectors');
        DAYS.forEach((day, i) => {
            const div = document.createElement('div');
            // 夜間シフト('s3','s4','s5')は火・水・木（index 1,2,3）のみ選択可能にする
            const isNightShiftAllowed = [1, 2, 3].includes(i); 

            div.innerHTML = `
                <label for="day-${i}" class="block text-sm font-medium text-slate-700">${day}曜日</label>
                <select id="day-${i}" class="mt-1 w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    ${Object.keys(SHIFTS).filter(key => {
                        // keyが夜間シフト（s3,s4,s5）で、かつ許可されていない曜日（isNightShiftAllowedがfalse）の場合、選択肢から除外する
                        if (['s3', 's4', 's5'].includes(key) && !isNightShiftAllowed) {
                            return false;
                        }
                        return true;
                    }).map(key => `
                        <option value="${key}" ${state.schedule[i] === key ? 'selected' : ''}>${SHIFTS[key].name.split(' ')[0]}</option>
                    `).join('')}
                </select>
            `;
            scheduleSelectors.appendChild(div);
        });
        
        // Event Listeners
        document.getElementById("hourly").addEventListener("input", render);
        document.getElementById("eveningHourly").addEventListener("input", render);
        // Removed event listener for weeksPerMonth
        scheduleSelectors.addEventListener("change", render);
        
        document.getElementById('presetA').addEventListener('click', () => loadPattern(PATTERN_A));
        document.getElementById('presetB').addEventListener('click', () => loadPattern(PATTERN_B));
        document.getElementById('presetC').addEventListener('click', () => loadPattern(PATTERN_C));
        document.getElementById('presetD').addEventListener('click', () => loadPattern(PATTERN_D));
        
        render(); // Initial render
    }

    document.addEventListener('DOMContentLoaded', setup);
  </script>
</body>
</html>

